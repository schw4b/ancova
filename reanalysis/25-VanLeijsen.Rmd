---
title: "25-VanLeigsen"
author: "Simon Schwab, Audrey Yeo"
date: "11/13/2019"
output: html_document
---

# Reference
Van Leijsen et al. (2017). Plasma Aβ (Amyloid-β) Levels and Severity and Progression of Small Vessel Disease. *Stroke*, 16(5), 351–359. https://doi.org/10.1161/STROKEAHA.117.019810

We first load the appropriate packages
```{r, eval=TRUE, echo=FALSE, include = FALSE}
#Setting up libraries
knitr::opts_chunk$set(echo = TRUE)
library(biostatUZH)
library(car)
library(readxl)
library(foreign)
library(readxl)
library(ggplot2)
library(tidyr)
library(beeswarm)
```

# Notes from reading methods section

* Dependant variable: AB38
* The independant variables 
  * ≥ 1 microbleeds (n = 81) 
  * no microbleed (n=405)
  * ≥ 1 lacunes (n = 132)
  * no lacunes (n = 355)
* Covariate: age

```{r, eval=TRUE, echo=FALSE, include = FALSE}
stats.orig.IV = data.frame(
  Fvalue =  NA,
  df1 = NA,
  df2 = NA,
  pvalue = 0.01,
  MD = NA,
  lowerCI = NA,
  upperCI = NA)

stats.orig.CV = stats.orig.IV
```

# Reading data
Data is loaded, reshaped if necessary, and factors are specified.
```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy = TRUE}
data = read_excel("../results/data/25-VanLeijsen/VanLeijsen-1.xlsx")
data = data.frame(data)
str(data)
data$mb_presence_b = data$mb_presence_b == 1
data$lac_presence_b = data$lac_presence_b == 1
data$sex.factor = NA
data$sex.factor[data$sex == 1] = "female"
data$sex[data$sex == 2] = "0"
data$sex.factor[data$sex == 0] = "male"
data$hypertension.factor = NA
data$hypertension  = data$hypertension == 1 

data$Group.factor = NA
data[data$mb_presence_b == TRUE,]$Group.factor = "microbleed"
data[data$mb_presence_b == FALSE,]$Group.factor = "no microbleed"
data[data$lac_presence_b == TRUE,]$Group.factor = "lacunes"
data[data$lac_presence_b == FALSE,]$Group.factor = "no lacunes"
unique(data$Group.factor)
data$Group.factor = factor(data$Group.factor,
                           levels = c("microbleed", "no microbleed",
                                      "lacunes", "no lacunes"))


```

# Descriptives 
## DV with boxplot
Number of samples and mean (SD) in levels of the independant variables. We reproduce the mean and sd values of Table 2 of this study
```{r}
a = sprintf("%.1f (%.1f)", mean(data$AB38[data$mb_presence_b == 0]), sd(data$AB38[data$mb_presence_b == 0]))
b = sprintf("%.1f (%.1f)", mean(data$AB38[data$mb_presence_b == 1]), sd(data$AB38[data$mb_presence_b == 1]))

c = sprintf("%.1f (%.1f)", mean(data$AB38[data$lac_presence_b == 0]), sd(data$AB38[data$lac_presence_b == 0]))
d = sprintf("%.1f (%.1f)", mean(data$AB38[data$lac_presence_b == 1]), sd(data$AB38[data$mb_presence_b == 1]))

idx = c(1, 3, 2, 4) # sorting as in publication
tab.dv = array(NA, dim=c(4,3))
tab.dv[,1] = levels(data$Group.factor)
tab.dv[,2] = c("81", "405", "132", "355")
tab.dv[,3] = c(a, b, c, d)
colnames(tab.dv) = c("group", "n", "mean (SD)")
print(tab.dv)
```
# boxplot with DV
```{r}
#IV : mb_presence_b
ggplot(data, aes(y=AB38, x = mb_presence_b, color =mb_presence_b )) +
  geom_jitter() +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.15, height = 0)) +
  theme_minimal() +
  theme(axis.text.x = element_blank(), legend.title = element_blank()) +
  xlab("Microbleed Presence") + ylab("AB38") + ggtitle("Dependant variable")
#IV : lac_presence_b
ggplot(data, aes(y=AB38, x = lac_presence_b, color =lac_presence_b )) +
  geom_jitter() +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.15, height = 0)) +
  theme_minimal() +
  theme(axis.text.x = element_blank(), legend.title = element_blank()) +
  xlab("Lacune Presence") + ylab("AB38") + ggtitle("Dependant variable")
```
  
# Descriptives 
## COV with boxplot
```{r}
e = sprintf("%.1f (%.1f)", mean(data$age[data$mb_presence_b == 0]), sd(data$age[data$mb_presence_b == 0]))
f = sprintf("%.1f (%.1f)", mean(data$age[data$mb_presence_b == 1]), sd(data$age[data$mb_presence_b == 1]))
g = sprintf("%.1f (%.1f)", mean(data$age[data$lac_presence_b == 0]), sd(data$age[data$lac_presence_b == 0]))
h = sprintf("%.1f (%.1f)", mean(data$age[data$lac_presence_b == 1]), sd(data$age[data$mb_presence_b == 1]))

idx = c(1, 3, 2, 4) # sorting as in publication
tab.cv = array(NA, dim=c(4,3))
tab.cv[,1] = levels(data$Group.factor)
tab.cv[,2] = c("81", "405", "132", "355")
tab.cv[,3] = c(e,f,g,h)
colnames(tab.cv) = c("group", "n", "mean (SD)")
print(tab.cv)
```

```{r}
ggplot(data, 
       aes(y=AB38, x=age, color=Group.factor)) +
  geom_jitter() +
  geom_boxplot() +
  theme(legend.title = element_blank()) +
  labs(x = "age", y = "AB30", title = "" )
```

# Main analysis ANCOVA
```{r, include=FALSE}
stats.orig.IV = data.frame(
  Fvalue =  NA,
  df1 = NA,
  df2 = NA,
  pvalue = NA,
  MD = NA,
  lowerCI = NA,
  upperCI = NA)

stats.orig.CV = stats.orig.IV

# enter all results from primary study here
stats.orig.IV$pvalue = 0.001
``` 

We verify the p values stated in Table 2 with respect to variables.
```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy = TRUE}
# Orthogonal contrasts
contrasts(data$Group.factor) = contr.helmert(4) 
result = Anova(fit, type = 3) # this is not a balanced study
print(result)
result$Df[4]

#contrasts(data$IV)<-cbind(c(-2,1,1), c(0,-1,1))
fit <- aov(AB38 ~ mb_presence_b + lac_presence_b + sex.factor + age + hypertension, data = data)
summary(fit)

```

```{r, include=FALSE}
stats.rep.IV = data.frame(Fvalue = sprintf("%.2f",result$`F value`[3]),
                          df1 = result$Df[3],
                          df2 = result$Df[4],
                          pvalue = formatPval(result$`Pr(>F)`[3]),
                          MD = NA,
                          lowerCI = NA,
                          upperCI = NA
)

stats.rep.CV = data.frame(Fvalue = sprintf("%.2f",result$`F value`[2]),
                          df1 = result$Df[2],
                          df2 = result$Df[4],
                          pvalue = formatPval(result$`Pr(>F)`[2]),
                          MD = NA,
                          lowerCI = NA,
                          upperCI = NA
)
```

# Comparing ANCOVA in original study with reanalysis
## Independant variable
```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy = TRUE}
tab.IV = rbind(stats.orig.IV, stats.rep.IV)
rownames(tab.IV) = c("original Study", "reanalysis")
print(t(tab.IV))
```
## Covariate
```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy = TRUE}
tab.CV = rbind(stats.orig.CV, stats.rep.CV)
rownames(tab.CV) = c("original Study", "reanalysis")
print(t(tab.CV))
```
# Assumptions
## 1.  Homogeneity of variance
* ANOVA/ANCOVA is fairly robust in terms of the error rate when sample sizes are equal.
* When groups with larger sample sizes have larger variances than the groups with smaller sample sizes, the resulting F-ratio tends to be conservative. That is, it's more likely to produce a non-significant result when a genuine difference does exist in the population.
* Conversely, when the groups with larger sample sizes have smaller variances than the groups with smaller samples sizes, the resulting F-ratio tends to be liberal and can inflate the false positive rate.
```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy = TRUE}
tapply(data$AB38, data$mb_presence_b, sd)
tapply(data$AB38, data$lac_presence_b, sd)
leveneTest(AB38 ~ lac_presence_b, data = data) 
leveneTest(AB38 ~ mb_presence_b, data = data)
```
## 2.  Independence between covariate and IV
The IV of this study have evidence of significant effect to the plasma level AB38.
```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy = TRUE}
fit.cv = aov(AB38 ~ lac_presence_b + mb_presence_b, data = data) 
summary(fit.cv)
```

## 3. Homogeneity of regression slopes
```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy = TRUE}
fit.hrs = aov(AB38 ~ age*mb_presence_b, data = data)
Anova(fit.hrs, type=3) # no evidence of interaction, there is homogeneity of IV levels across age
fit.hrs = aov(AB38 ~ age*lac_presence_b, data = data)
Anova(fit.hrs, type=3) 

```

## Independance of Covariate with Independant Variables
```{r fig.height=2, fig.width=3.5}
ggplot(data, aes(y=AB38, x= age, color= mb_presence_b)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.15, height = 0)) +
  theme_minimal() +
  theme(axis.text.x = element_blank(), legend.title = element_blank()) +
  xlab("group") + ylab("AB38") + ggtitle("Covarate")
```

