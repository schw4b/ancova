---
title: "25-VanLeijsen"
author: "Audrey Yeo"
date: "11/13/2019"
output: pdf_document
---

# Reference
Van Leijsen et al. (2017). Plasma AB (Amyloid-B) Levels and Severity and Progression of Small Vessel Disease. Stroke, 16(5), 351â€“359. https://doi.org/10.1161/STROKEAHA.117.019810

We first load the appropriate packages
```{r, eval=TRUE, echo=FALSE, include = TRUE}
#Setting up libraries
knitr::opts_chunk$set(echo = TRUE)
library(biostatUZH)
library(car)
library(readxl)
library(foreign)
library(readxl)
library(ggplot2)
library(tidyr)
library(beeswarm)
```

# Notes from reading methods section

* Dependant variable: AB38
* The independant variables 
  * 1 or more microbleeds (n = 81) 
  * no microbleed (n=405)
  * 1 or more lacunes (n = 132)
  * no lacunes (n = 355)
* Covariate: age, sex and hypertension

```{r}
stats.orig.IV = data.frame(
  Fvalue =  NA,
  df1 = NA,
  df2 = NA,
  pvalue = "<0.01") # for microbleed presence and for lacune presence groups
  

stats.orig.allCV =  data.frame(
  Fvalue =  NA,
  df1 = NA,
  df2 = NA,
  pvalue = NA)
```

# Reading data
Data is loaded, reshaped if necessary, and factors are specified.
```{r}
data = read_excel("../results/data/25-VanLeijsen/VanLeijsen-1.xlsx")
data = data.frame(data)
str(data)
data$mb_presence_b = data$mb_presence_b == 1
data$lac_presence_b = data$lac_presence_b == 1
data$sex.factor = NA
data$sex.factor[data$sex == 1] = "male"
data$sex.factor[data$sex == 2] = "female"
data$sex.factor[data$sex.factor == "male" ] = 1
data$sex.factor[data$sex.factor == "female" ] = 0
data$sex.factor = as.factor(data$sex.factor)
data$hypertension.factor = NA
data$hypertension  = data$hypertension == 1 

data$Group.factor = NA # only used for table
data[data$mb_presence_b == TRUE,]$Group.factor = "microbleed"
data[data$mb_presence_b == FALSE,]$Group.factor = "no microbleed"
data[data$lac_presence_b == TRUE,]$Group.factor = "lacunes"
data[data$lac_presence_b == FALSE,]$Group.factor = "no lacunes"
unique(data$Group.factor)
data$Group.factor = factor(data$Group.factor,
                           levels = c("no microbleed", "microbleed",
                                      "no lacunes", "lacunes"))
```

# Descriptives 
Number of samples and mean (SD) in levels of the independant variables. We reproduce the mean and sd values of Table 2 of this study
```{r}
a = sprintf("%.1f (%.1f)", mean(data$AB38[data$mb_presence_b == 0]), sd(data$AB38[data$mb_presence_b == 0]))
b = sprintf("%.1f (%.1f)", mean(data$AB38[data$mb_presence_b == 1]), sd(data$AB38[data$mb_presence_b == 1]))

c = sprintf("%.1f (%.1f)", mean(data$AB38[data$lac_presence_b == 0]), sd(data$AB38[data$lac_presence_b == 0]))
d = sprintf("%.1f (%.1f)", mean(data$AB38[data$lac_presence_b == 1]), sd(data$AB38[data$lac_presence_b == 1]))

idx = c(1, 3, 2, 4) # sorting as in publication
tab.dv = array(NA, dim=c(4,3))
tab.dv[,1] = levels(data$Group.factor)
tab.dv[,2] = c("405", "81", "355", "132")
tab.dv[,3] = c(a, b, c, d)
colnames(tab.dv) = c("group", "n", "mean (SD)")
print(tab.dv)
```
# boxplot with DV
* Upon visual inspection, each level of each independant group seem to have a similar outcome effect.
```{r, fig.height=3, fig.width=4.5}
#IV : mb_presence_b
ggplot(data, aes(y=AB38, x = mb_presence_b, color =mb_presence_b )) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.15, height = 0)) +
  theme_minimal() +
  theme(axis.text.x = element_blank(), legend.title = element_blank()) +
  xlab("Microbleed Presence") + ylab("AB38") + 
  ggtitle("Dependant variable with Microbleed presence")
#IV : lac_presence_b
ggplot(data, aes(y=AB38, x = lac_presence_b, color =lac_presence_b )) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.15, height = 0)) +
  theme_minimal() +
  theme(axis.text.x = element_blank(), legend.title = element_blank()) +
  xlab("Lacune Presence") + ylab("AB38") + 
  ggtitle("Dependant variable with Lacune presence")
```
  
# Descriptives 
## COV with boxplot
```{r}
e = sprintf("%.1f (%.1f)", mean(data$age[data$mb_presence_b == 0]), 
            sd(data$age[data$mb_presence_b == 0]))
f = sprintf("%.1f (%.1f)", mean(data$age[data$mb_presence_b == 1]), 
            sd(data$age[data$mb_presence_b == 1]))
g = sprintf("%.1f (%.1f)", mean(data$age[data$lac_presence_b == 0]), sd(data$age[data$lac_presence_b == 0]))
h = sprintf("%.1f (%.1f)", mean(data$age[data$lac_presence_b == 1]), sd(data$age[data$lac_presence_b == 1]))

idx = c(1, 3, 2, 4) # sorting as in publication
tab.cv = array(NA, dim=c(4,3))
tab.cv[,1] = levels(data$Group.factor)
tab.cv[,2] = c("405", "81", "355" , "132")
tab.cv[,3] = c(e,f,g,h)
colnames(tab.cv) = c("group", "n", "mean (SD)")
print(tab.cv)
```
* Age upon visual inspection is similar between groups
```{r, fig.height=3, fig.width=4.5}
ggplot(data, 
       aes(y=age, x=mb_presence_b, color=mb_presence_b)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.15, height = 0)) +
  theme(legend.title = element_blank()) + theme_minimal() + 
  theme(axis.text.x = element_blank(), legend.title = element_blank()) +
  labs(x = "Lacune presence", y = "Age", title = "" )
ggplot(data, 
       aes(y=age, x=lac_presence_b, color=lac_presence_b)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.15, height = 0)) +
  theme(legend.title = element_blank()) + theme_minimal() + 
  theme(axis.text.x = element_blank(), legend.title = element_blank()) +
  labs(x = "Lacune presence", y = "Age", title = "" )
```

# Main analysis ANCOVA
```{r}
stats.orig.IVmicrobleed = data.frame(
  Fvalue =  NA,
  df1 = NA,
  df2 = NA,
  pvalue = "<0.01")

stats.orig.IVlacunes = data.frame(
  Fvalue =  NA,
  df1 = NA,
  df2 = NA,
  pvalue = "<0.01")

``` 

We verify the p values stated in Table 2 with respect to variables.There is evidence of significance that Age as a covariate contribute to variance in outcome (p = 3.825e-13)
```{r}
# Orthogonal contrasts
contrasts(data$mb_presence_b) = contr.helmert(2) 
contrasts(data$lac_presence_b) = contr.helmert(2) 

#contrasts(data$IV)<-cbind(c(-2,1,1), c(0,-1,1))
fit <- aov(AB38 ~ age + sex.factor + hypertension + mb_presence_b*lac_presence_b , data = data)
summary(fit) # we use interaction term because we have lacunes yes microbleeds no
result = Anova(fit, type = 3) # this is not a balanced study, since ordering of variables matter, we use this
print(result)
```

```{r}
stats.rep.IVmicrobleeds = data.frame(Fvalue = sprintf("%.2f",result$`F value`[5]),
                          df1 = result$Df[5],
                          df2 = result$Df[8],
                          pvalue = formatPval(result$`Pr(>F)`[5]))

stats.rep.IVlacunes = data.frame(Fvalue = sprintf("%.2f",result$`F value`[6]),
                          df1 = result$Df[6],
                          df2 = result$Df[8],
                          pvalue = formatPval(result$`Pr(>F)`[6]))

stats.rep.CVage = data.frame(Fvalue = sprintf("%.2f",result$`F value`[2]),
                          df1 = result$Df[2],
                          df2 = result$Df[8],
                          pvalue = formatPval(result$`Pr(>F)`[2]))

stats.rep.CVsex = data.frame(Fvalue = sprintf("%.2f",result$`F value`[3]),
                          df1 = result$Df[3],
                          df2 = result$Df[8],
                          pvalue = formatPval(result$`Pr(>F)`[3]))

stats.rep.CVhypertension = data.frame(Fvalue = sprintf("%.2f",result$`F value`[4]),
                          df1 = result$Df[4],
                          df2 = result$Df[8],
                          pvalue = formatPval(result$`Pr(>F)`[4]))
```

# Comparing ANCOVA in original study with reanalysis
## Independant variable
```{r}
tab.IV = rbind(stats.orig.IVmicrobleed, stats.orig.IVlacunes, stats.rep.IVmicrobleeds, stats.rep.IVlacunes)
rownames(tab.IV) = c("original study microbleed", "original Study lacunes", "reanalysis for IV microbleeds presence", "reanalysis for IV lacunes presence")
print(t(tab.IV))
```
## Covariate
* The study does not report results from covariate of age
```{r}
tab.CV = rbind(stats.orig.allCV, stats.rep.CVage, stats.rep.CVsex, stats.rep.CVhypertension)
rownames(tab.CV) = c("original CV age,sex,hypertension", "reanalysis age", "reanalysis sex", "reanalysis hypertension")
print(t(tab.CV))
```
# Assumptions
## 1.  Homogeneity of variance
* ANOVA/ANCOVA is fairly robust in terms of the error rate when sample sizes are equal.
* When groups with larger sample sizes have larger variances than the groups with smaller sample sizes, the resulting F-ratio tends to be conservative. That is, it's more likely to produce a non-significant result when a genuine difference does exist in the population.
* Conversely, when the groups with larger sample sizes have smaller variances than the groups with smaller samples sizes, the resulting F-ratio tends to be liberal and can inflate the false positive rate.
* In this study, statistical descriptives show that the highest and lowest variances seem close. Also, there is homogeneity of variance as p values exceed 0.05 for the Levene's test
```{r}
tapply(data$AB38, data$mb_presence_b, sd)
tapply(data$AB38, data$lac_presence_b, sd)
leveneTest(AB38 ~ lac_presence_b, data = data) 
leveneTest(AB38 ~ mb_presence_b, data = data)
```
## 2.  Independence between covariate and IV
* The Independant variable of this study have evidence of significant effect to the covariate Age and Hypertension (for Lacune presence only). The assumption thus does not hold for Age and for Hypertension for the lacunes group which may influence the interpretation of the results from the ANCOVA analysis. The variable sex is independant to the independant variable and is an appropriate covariate to include. 
* As a way of comparison, we perform a two way anova to assess the main effect of two independant variables without covariates and find that there is evidence of significant of influence of Independant variables to Dependant variable.
```{r}
fit.cvage = aov(age ~ lac_presence_b + mb_presence_b, data = data) 
summary(fit.cvage)
fit.cvsex = glm(sex.factor ~ lac_presence_b + mb_presence_b, family = binomial, data = data) 
summary(fit.cvsex)
fit.cvhypertension = glm(hypertension ~ lac_presence_b + mb_presence_b, family = binomial, data = data) 
summary(fit.cvhypertension )
fit.main <- aov(AB38 ~ mb_presence_b + lac_presence_b, data = data) #checking DV and IV alone
summary(fit.main)
```

## 3. Homogeneity of regression slopes
* There is no evidence of significant interaction between covariate and independant variable. Thus we can assume homogeneity of regression slope. 
```{r}
#alternatively Anova(aov(AB38 ~age*mb_presence_b + age + mb_presence_b, data = data), type = 3)
fit.hrs_mic = aov(AB38 ~ age*mb_presence_b, data = data)
Anova(fit.hrs_mic, type=3) # no evidence of interaction, there is homogeneity of IV levels across age
fit.hrs_lac = aov(AB38 ~ age*lac_presence_b, data = data)
Anova(fit.hrs_lac, type=3) 
```

## Independance of Covariate with Independant Variables (Visual inspection of Homogeneity of Regression slopes)
* Visually, the two levels of each independant variable follows the same pattern - there seems to be independance of Covariate versus independant variable.
```{r fig.height=2, fig.width=3.5}
ggplot(data, aes(y=AB38, x= age, color= mb_presence_b)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.15, height = 0), alpha = 0.05) +
  geom_smooth(formula = y ~ x,method=lm, se=FALSE, fullrange=TRUE) +
  theme_minimal() +
  theme(axis.text.x = element_blank(), legend.title = element_blank()) +
  xlab("Age") + ylab("AB38") + ggtitle("Covariate with Microbleed presence")

ggplot(data, aes(y=AB38, x= age, color= lac_presence_b)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.15, height = 0), alpha = 0.05) +
  geom_smooth(formula = y ~ x,method=lm, se=FALSE, fullrange=TRUE) +
  theme_minimal() +
  theme(axis.text.x = element_blank(), legend.title = element_blank()) +
  xlab("Age") + ylab("AB38") + ggtitle("Covariate with Lacune presence")
```
Reference : Field, Miles & Miles (2012), Discovering Statistics, Published by Sage Pub, UK.
