---
title: "25-VanLeigsen"
author: "Simon Schwab, Audrey Yeo"
date: "11/13/2019"
output: html_document
---

# Reference
Van Leijsen et al. (2017). Plasma Aβ (Amyloid-β) Levels and Severity and Progression of Small Vessel Disease. *Stroke*, 16(5), 351–359. https://doi.org/10.1161/STROKEAHA.117.019810

We first load the appropriate packages
```{r, eval=TRUE, echo=FALSE, include = FALSE}
#Setting up libraries
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(foreign)
library(readxl)
library(readstata13)
library(car) # for levene's test
library(effects)# for adjusted means
library(ggplot2) # for graphs
library(multcomp) #for post hoc test
library(pastecs)# for descriptive statistics
library(reshape)
library(effects)# for effect command
library(ggplot2)
library(beeswarm)
library(tidyr)
```

# Notes from reading methods section

* Dependant variable: "SVD" with number of events in each of three SVD markers
* The independant variables are plasma Aβ (three levels : Aβ38, Aβ40, Aβ42)
* Covariate: age

```{r, eval=TRUE, echo=FALSE, include = FALSE}

# We analyzed associations between plasma Aβ and SVD markers by ANCOVA adjusted for age, sex, and hypertension.

#We used 4 models to investigate the associations between plasma Aβ levels and SVD markers: model 1, unadjusted; model 2, adjusted for age and sex.
Fvalue =  NA
df1 = NA
df2 = NA
pvalue = NA
estimates = as.data.frame(cbind(F, df1, df2, pvalue))
rownames(estimates) = c("Study")
estimates
```

```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy = TRUE}
level1 = 3
level2 = 5
level3 = 3
combo <- level1*level2*level3 # possible number of DV based on counts of IV and each of their levels, = 45
```

Loading and Reshaping data if appropriate
```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy = TRUE}
data = read_excel("../results/data/25-VanLeijsen/VanLeijstudyNo25DATA.xlsx")
names(data)
DV = data$mb_presence_b #this is microbleed. lac_presence_b is also an SVD marker which is a DV
# there are two covariates analysed in this study
ageCOV = data$age
#sexCOV = data$sex
# IV is plasma AB which has three levels
ab38IV = data$AB38
ab40IV = data$AB40
ab42IV = data$AB42
data = gather(data, key = "IVlevel", "IVvalue", AB38, AB40, AB42) 
data = gather(data, key = "SVDmarker", "rate", mb_presence_b, lac_presence_b)
data



```
Running an initial ANCOVA

## Interpreting the main effects of ANCOVA
## Main effects of ANCOVA
```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy = TRUE}
#contrasts(data$IV)<-cbind(c(-2,1,1), c(0,-1,1))
ancovaModel<-aov(DV ~ IVlevel + ageCOV, data = data)
lm_ancova <- lm(DV ~ IVlevel + ageCOV, data = data)
summary.lm(ancovaModel)
Anova(ancovaModel) # this is not a balanced study

```
<p align="left">
  <b> Definitions </b>
</p>  
<p align="left">
- The rationale for ANCOVA is two folds:
  1. Reduce within-group error variance
  2. Eliminate confounders
- An ANOVA is a type of linear regression model, an ANCOVA is an ANOVA, which accounts for potential confounders which are usually continuous variables
- An ANCOVA model is the analysis of covariance where the variance of the outcome is explained by discrete variable (Independant variable) and covariates which are continuous variables.
</p>

Checking Assumptions 

## Motivation

<b>  </b> 
<p align="left">
- Initial one-way ANOVA show that there is no evidence of significant relationship between dose and libido, motivates to evaluate its underlying covariances to answer :
- What is the variance explained by three levels of plasma AB?
- And what is the variance explained by Covariate on SVD marker. 
</p>
```{r, include = TRUE, echo = TRUE, eval = TRUE, tidy = TRUE}
mod1 <- aov(DV ~ IVlevel, data = data)
mod1$coefficients
summary(mod1)
```
## Explore Data
<p align="left">
- Boxplot shows: Does different doses produce different outcomes
</p>
```{r, echo= TRUE, include = TRUE, eval = TRUE, tidy = TRUE}
#IV : Emotion
par(mfrow=c(1,2))
beeswarm(DV~IVlevel, data= data, main = "", pch = 16, col = rainbow(8))
boxplot(DV~IVvalue, data= data, outline = FALSE, main = " ", add= TRUE) 
```
## Explore Data : Descriptives
<p align="left">
- Descriptive Statistics
</p>
```{r, include = TRUE, echo = TRUE, eval = TRUE, tidy = TRUE}
by(data$DV, data$IVlevel, stat.desc)
```

## Explore Data : Graphical analysis for homogeneity of regression slopes
<p align="left">
- Say we want to know the overall relationship between Viagra and Partner libido, ignoring which dose groups the data points belong to, we therefore assume that the relationship between dose group and partner libido is constant across all doses. If the latter is not true, then the overall relationship between Viagra and Partner libido is inaccurate.
- there is homogeneity of regression slopes for Placebo and Lower doses
- there is no homogeneity of regression slopes for Placebo and High dose
- That's ok because there are situations where you might actually expect regression slopes to differ across groups and that this is, in itself, an interesting hypothesis. 
</p>

## Graphical Anaylsis for homogeneity of regression slopes

```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy = TRUE}

data %>% ggplot() +
+   geom_jitter(aes(COV, DV, colour = factor(EmotionIV))) +
+   geom_smooth(method = lm)

ggplot(data, aes(y = DV, x = EmotionIV, group = factor(EmotionIV), colour = factor(EmotionIV))) +  geom_jitter(aes(colour = factor(EmotionIV))) + geom_smooth(method = lm)
```

## Assumption 1 : Homogeneity of variance
<p align="left">
- Levene's Test: Are the variances between levels on outcome very similar ?
- A good double-check of Levene’s test is to look at the highest and lowest variances. For our levels we have standard deviations of .
</p>
```{r, include = TRUE, echo = TRUE, eval = TRUE, tidy = TRUE}
leveneTest(data$DV, data$ab38IV, center = median)
leveneTest(data$DV, data$ab40IV, center = median)
leveneTest(data$DV, data$ab42IV, center = median)
```
## Assumption 2 : Check that the covariate and any independent variables are independent

<p align="left">
- We run an ANOVA to find out if the covariance independant to each of the IV levels? 
- The summary results show that on different levels for each IV, there is no evidence of significant association to N1/P2 complex.
</p>
```{r, eval = TRUE, echo = TRUE}
checkIndependenceModel1<-aov(COV ~ ab38IV, data = data) 
checkIndependenceModel2<-aov(COV ~ ab40IV, data = data)
checkIndependenceModel3<-aov(COV ~ ab32IV, data = data)
summary(checkIndependenceModel1)
summary(checkIndependenceModel2)
summary(checkIndependenceModel3)
```
## Residuals vs Fitted : Testing for Homogeneity of Variance
<p align="left">
- The residuals for fitted value are similar to zero, assumption for homogeneity of variance held.
</p>
```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy= TRUE, fig.width = 6, fig.height = 5}
plot(ancovaModel, which = 1)
```
## QQ plots
<p align="left">
- Residuals are normally distributed
</p>
```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy =TRUE, fig.width = 4, fig.height = 5}
plot(ancovaModel, which = 2)
```
## Post Hoc Tests 
<p align="left">
- A Tukey-Ascombe test is performed via a general linear hypotheses function from library(multcomp).
- It is used for a pairwise comparison t test between doses for between groups differences
- In other words: we want to test differences between the adjusted means.
- In this case, the differences between IV levels can be compared with evidence of significance.
- In this method, we are restricted to the Tukey and the Dunnett method.
</p>
```{r, include = TRUE, echo = TRUE, eval = TRUE}
postHocs<-glht(ancovaModel, linfct = mcp(ab38IV = "Tukey"))
summary(postHocs)
confint(postHocs)
```
## Going back to Basic Assumptions : Homogeneity of Regression Slopes
<p align="left">
There is a positive relationship between all IV and Covariate.
</p>
```{r, include = TRUE, echo = TRUE, eval = TRUE}
#IVA <- c(EmotionIV, IntensityIV, ElectrodeIV)
# IVA[1]
# for (i in 1:3){assign(paste0("hoRs",i, aov(DV ~ COV*IV[i], data = data)))} 

hoRS1<-aov(DV ~ ageCOV*ab38IV, data = data)
hoRS2<-aov(DV ~ gaeCOV*ab40IV, data = data)
hoRS2<-aov(DV ~ gaeCOV*ab41IV, data = data)

hoRS1<-update(ancovaModel, .~. + ageCOV:ab38IV)
hoRS2<-update(ancovaModel, .~. + ageCOV:ab40IV)
hoR3S<-update(ancovaModel, .~. + gaeCOV:ab42IV)

summary(hoRS1) 
summary(hoRS2)
summary(hoR3S)

df01 <- Anova(hoRS1, type="I")
df02 <- Anova(hoRS1, type="I")
df03 <- Anova(hoRS1, type="I")

df <- as.data.frame(c(df01[3, 3:4],df02[3, 3:4],df03[3, 3:4]))
```

## Creating a data frame 
<p align="left">
- 
</p>
```{r}
reanalysis = cbind(FvalueR, df1R, df2R, pvalueR)
rownames(reanalysis) = c("Reanalysis")
estimates = rbind(estimates, reanalysis)
```

