---
title: "25-VanLeigsen"
author: "Simon Schwab, Audrey Yeo"
date: "11/13/2019"
output: html_document
---

# Reference
Van Leijsen et al. (2017). Plasma Aβ (Amyloid-β) Levels and Severity and Progression of Small Vessel Disease. *Stroke*, 16(5), 351–359. https://doi.org/10.1161/STROKEAHA.117.019810

We first load the appropriate packages
```{r, eval=TRUE, echo=FALSE, include = FALSE}
#Setting up libraries
knitr::opts_chunk$set(echo = TRUE)
library(biostatUZH)
library(car)
library(readxl)
library(foreign)
library(readxl)
library(ggplot2)
```

# Notes from reading methods section

* Dependant variable: "SVD", a continuous variable measured by SPM12 sytem
* The independant variables are (categorically) plasma Aβ (three levels : Aβ38, Aβ40, Aβ42)
* Covariate: age

```{r, eval=TRUE, echo=FALSE, include = FALSE}
Fvalue =  NA
df1 = NA
df2 = NA
pvalue = NA
estimates = as.data.frame(cbind(F, df1, df2, pvalue))
rownames(estimates) = c("Study")
estimates
```

# Reading data
Data is loaded, reshaped if necessary, and factors are specified.
```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy = TRUE}
data = read_excel("../results/data/25-VanLeijsen/VanLeijstudyNo25DATA.xlsx")
data = gather(data, key = "IVlevel", "IVvalue", mb_presence_b, lac_presence_b) 

data = data[data$IVvalue == "1",] # we chose mb_presence_b = 1

# datanolac = data[data$mb_presence_b == "0"]
# datamic = data[data$mb_presence_b == "1"]
# datanomic = data[data$mb_presence_b == "0"]

#DV = data$tbv_b
# there are two covariates analysed in this study
#ageCOV = data$age
#sexCOV = data$sex
# IV is plasma AB which has three levels
# ab38IV = data$AB38
# ab40IV = data$AB40
# ab42IV = data$AB42

# subset this data 
# datalac = data[data$mb_presence_b == "1"]
# datanolac = data[data$mb_presence_b == "0"]
# datamic = data[data$mb_presence_b == "1"]
# datanomic = data[data$mb_presence_b == "0"]
#data = gather(data, key = "SVDmarker", "rate", mb_presence_b, lac_presence_b)
#data
```

# Descriptives
## Dependant variable
Number of samples and mean (SD) in levels of the independant variables. We reproduce Table 3 and Figure 2A of the study.

# Main analysis ANCOVA
```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy = TRUE}
#contrasts(data$IV)<-cbind(c(-2,1,1), c(0,-1,1))
ancovaModel <-aov(AB38 ~ age, 
                  data = data)
lm_ancova <- lm(tbv_b ~ IVlevel + age, 
                data = data)
summary.lm(ancovaModel)

# Orthogonal contrasts
contrasts(data$IVvalue) = contr.helmert(3) #doesnt work
result = Anova(ancovaModel, type = 3) # this is not a balanced study
print(result)
```

```{r, include=FALSE}
stats.rep.IV = data.frame(Fvalue = sprintf("%.2f",result$`F value`[3]),
                          df1 = result$Df[3],
                          df2 = result$Df[4],
                          pvalue = formatPval(result$`Pr(>F)`[3]),
                          MD = NA,
                          lowerCI = NA,
                          upperCI = NA
)

stats.rep.CV = data.frame(Fvalue = sprintf("%.2f",result$`F value`[2]),
                          df1 = result$Df[2],
                          df2 = result$Df[4],
                          pvalue = formatPval(result$`Pr(>F)`[2]),
                          MD = NA,
                          lowerCI = NA,
                          upperCI = NA
)
```


# Comparing ANCOVA in original study with reanalysis
## Independant variable
```{r}
tab.IV = rbind(stats.orig.IV, stats.rep.IV)
rownames(tab.IV) = c("original Study", "reanalysis")
print(t(tab.IV))
```

## Covariate
```{r}
tab.CV = rbind(stats.orig.CV, stats.rep.CV)
rownames(tab.CV) = c("original Study", "reanalysis")
print(t(tab.CV))
```


# Comparing ANCOVA in original study with reanalysis
## Independant variable
```{r}
tab.IV = rbind(stats.orig.IV, stats.rep.IV)
rownames(tab.IV) = c("original Study", "reanalysis")
print(t(tab.IV))
```
## Covariate
```{r}
tab.CV = rbind(stats.orig.CV, stats.rep.CV)
rownames(tab.CV) = c("original Study", "reanalysis")
print(t(tab.CV))
```
# Assumptions
## 1.  Homogeneity of variance
* ANOVA/ANCOVA is fairly robust in terms of the error rate when sample sizes are equal.
* When groups with larger sample sizes have larger variances than the groups with smaller sample sizes, the resulting F-ratio tends to be conservative. That is, it's more likely to produce a non-significant result when a genuine difference does exist in the population.
* Conversely, when the groups with larger sample sizes have smaller variances than the groups with smaller samples sizes, the resulting F-ratio tends to be liberal and can inflate the false positive rate.
```{r}
tapply(data$AB38, data$IVlevel, sd)
leveneTest(AB38 ~ data$IVlevel, data = data) # the variance of group to DV has evidence of significance
```


## 2.  Independence between covariate and IV
When the covariate and the experimental effect (independent variable) are not independent the treatment effect is obscured, spurious treatment effects can arise and the interpretation of the ANCOVA is seriously compromised.

We test whether our groups differ on the CV. If the groups do not significantly differ then is appropriate to use the covariate.
```{r}
fit.cv = aov(AB38 ~ IVlevel, data = data) 
summary(fit.cv)
```

## 3. Homogeneity of regression slopes
```{r}
fit.hrs = aov(AB38 ~ age*IVlevel, data = data)
Anova(fit.hrs, type=3) # no evidence of interaction, there is homogeneity of IV levels across age
```

```{r fig.height=2, fig.width=3.5}
ggplot(data, 
       aes(y=AB38, x=age, color=IVlevel, shape=IVlevel)) +
  geom_jitter(aes(colour = factor(IVlevel))) +
  geom_smooth(formula = y ~ x, method=lm, se=TRUE, fullrange=TRUE) +
  theme_minimal() +
  theme(legend.title = element_blank()) +
  xlab("age") + ylab("AB30") -> hey

ggplot(viagraData, aes(partnerLibido, libido, colour = dose)) +
  geom_jitter(aes(colour = factor(dose))) +
  geom_smooth(method = lm)

```

# Additional data exploration
<p align="left">
- Boxplot shows: Does different doses produce different outcomes
</p>
```{r, echo= TRUE, include = TRUE, eval = TRUE, tidy = TRUE}
#IV : Emotion
par(mfrow=c(1,2))
beeswarm(AB38 ~ IVlevel, data = data, main = "", pch = 16, col = rainbow(8), add = TRUE)
boxplot(AB38 ~ IVlevel, data = data, outline = FALSE, main = " ") 
```
## Explore Data : Descriptives
<p align="left">
- Descriptive Statistics
</p>
```{r, include = TRUE, echo = TRUE, eval = TRUE, tidy = TRUE}
by(data$tbv_b, data$IVlevel, stat.desc)
```

## Explore Data : Graphical analysis for homogeneity of regression slopes
<p align="left">
- Say we want to know the overall relationship between Viagra and Partner libido, ignoring which dose groups the data points belong to, we therefore assume that the relationship between dose group and partner libido is constant across all doses. If the latter is not true, then the overall relationship between Viagra and Partner libido is inaccurate.
- there is homogeneity of regression slopes for Placebo and Lower doses
- there is no homogeneity of regression slopes for Placebo and High dose
- That's ok because there are situations where you might actually expect regression slopes to differ across groups and that this is, in itself, an interesting hypothesis. 
</p>

## Graphical Anaylsis for homogeneity of regression slopes

```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy = TRUE}

ggplot(data) +
  geom_jitter(data, aes(x=age, y=AB38, colour = factor(IVlevel))) +
  geom_smooth(x= age, y = AB38, method = lm)

ggplot(data, aes(y = AB38, x = age, group = factor(age), colour = factor(age))) +  geom_jitter(aes(colour = factor(age))) + geom_smooth(method = lm)
```

## Assumption 1 : Homogeneity of variance
<p align="left">
- Levene's Test: Are the variances between levels on outcome very similar ?
- A good double-check of Levene’s test is to look at the highest and lowest variances. For our levels we have standard deviations of .
</p>
```{r, include = TRUE, echo = TRUE, eval = TRUE, tidy = TRUE}
leveneTest(data$AB38, data$IVlevel, center = median) #the variances between the levels have no evidence of significance. There is a "common" variance per IV level
```
## Assumption 2 : Check that the covariate and any independent variables are independent

<p align="left">
- We run an ANOVA to find out if the covariance independant to each of the IV levels? 
- The summary results show that on different levels for each IV, there is no evidence of significant association to outcome
</p>
```{r, eval = TRUE, echo = TRUE}
checkIndependenceModel1<-aov(AB38 ~ IVlevel, data = data) 
summary(checkIndependenceModel1) # the IV levels are independant to outcome
```
## Residuals vs Fitted : Testing for Homogeneity of Variance
<p align="left">
- The residuals for fitted value are similar to zero, assumption for homogeneity of variance held.
</p>
```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy= TRUE, fig.width = 6, fig.height = 5}
plot(ancovaModel, which = 1) # the residuals are homogenous with mean around zero
```
## QQ plots
<p align="left">
- Residuals are normally distributed
</p>
```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy =TRUE, fig.width = 4, fig.height = 5}
plot(ancovaModel, which = 2)
```
## Post Hoc Tests 
<p align="left">
- A Tukey-Ascombe test is performed via a general linear hypotheses function from library(multcomp).
- It is used for a pairwise comparison t test between doses for between groups differences
- In other words: we want to test differences between the adjusted means.
- In this case, the differences between IV levels can be compared with evidence of significance.
- In this method, we are restricted to the Tukey and the Dunnett method.
</p>
```{r, include = TRUE, echo = TRUE, eval = TRUE}
postHocs<-glht(ancovaModel, linfct = mcp(AB38 = "Tukey"))
summary(postHocs)
confint(postHocs)
```
## Going back to Basic Assumptions : Homogeneity of Regression Slopes
<p align="left">
There is a positive relationship between all IV and Covariate.
</p>
```{r, include = TRUE, echo = TRUE, eval = TRUE}
#IVA <- c(EmotionIV, IntensityIV, ElectrodeIV)
# IVA[1]
# for (i in 1:3){assign(paste0("hoRs",i, aov(DV ~ COV*IV[i], data = data)))} 

hoRS1<-aov(DV ~ ageCOV*ab38IV, data = data)
hoRS2<-aov(DV ~ gaeCOV*ab40IV, data = data)
hoRS2<-aov(DV ~ gaeCOV*ab41IV, data = data)

hoRS1<-update(ancovaModel, .~. + ageCOV:ab38IV)
hoRS2<-update(ancovaModel, .~. + ageCOV:ab40IV)
hoR3S<-update(ancovaModel, .~. + gaeCOV:ab42IV)

summary(hoRS1) 
summary(hoRS2)
summary(hoR3S)

df01 <- Anova(hoRS1, type="I")
df02 <- Anova(hoRS1, type="I")
df03 <- Anova(hoRS1, type="I")

df <- as.data.frame(c(df01[3, 3:4],df02[3, 3:4],df03[3, 3:4]))
```

## Creating a data frame 
<p align="left">
- 
</p>
```{r}
reanalysis = cbind(FvalueR, df1R, df2R, pvalueR)
rownames(reanalysis) = c("Reanalysis")
estimates = rbind(estimates, reanalysis)
```

