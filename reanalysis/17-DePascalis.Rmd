---
title: "17-DePascalis"
author: "Simon Schwab, Audrey Yeo"
date: "17/07/2019"
output: pdf_document
---

# Reference
DePascalis. (2017). Serotonin and dopamine transporter PET changes in the premotor phase of LRRK2 parkinsonism: cross-sectional studies. *Lancet Neurology*, 16(5), 351–359. https://doi.org/10.1038/srep41588

We first load the appropriate packages
```{r, eval=TRUE, echo=FALSE, include = FALSE}
#Setting up libraries
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(foreign)
library(readxl)
library(car) # for levene's test
library(effects)# for adjusted means
library(ggplot2) # for graphs
library(multcomp) #for post hoc test
library(pastecs)# for descriptive statistics
library(reshape)
library(effects)# for effect command
library(ggplot2)
library(beeswarm)
library(tidyr)
library(tidyverse)
library(ggpubr)
library(rstatix)
```

#Paper's results section

* DV: "N1/P2 complex" (n = 39)
* IV: 
 * Emotion (3 levels), 
 * Auditory Intensity (five levels), 
 * Recording side (three levels) (n = 39)
* COV: RST (n = 39)

```{r, eval=TRUE, echo=FALSE, include = FALSE}
# A similar ANCOVA performed on the N1/P2 slope scores found a highly significant main effect for the BIS, F1,37=13.12, p=0.0009, η2=0.35, indicating lower slopes for high-BIS individuals compared to low-BIS participants (Fig. 2c).
stats.orig.IV = data.frame(
  Fvalue =  NA,
  df1 = NA,
  df2 = NA,
  pvalue = "") # for 
  
stats.orig.allCV =  data.frame(
  Fvalue =  NA,
  df1 = NA,
  df2 = NA,
  pvalue = NA)
```

# Reading data
Data is loaded, reshaped if necessary, and factors are specified.
```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy = TRUE}
data = read_excel("../results/data/17-DePascalis/17-DePascalis-1.xlsx", skip = 4)
names(data)
dim(data)
# correcting typo
colnames(data)[2] <- "Subject"


#creating a long form data set, first pull columns and set as class data.frame, then name columns #39 * 15 different levels is 353
EmotionIV <- as.data.frame(c(rep("Neutral", 585), rep("Negative", 585), rep("Positive", 585)))
colnames(EmotionIV) <- "EmotionIV"
dim(EmotionIV)
head(EmotionIV)

IntensityIV <- as.data.frame(c(rep("One", 351), rep("Two", 351), rep("Three", 351), rep("Four", 351), rep("Five", 351)))
colnames(IntensityIV) <- "IntensityIV"
dim(IntensityIV)

ElectrodeIV <- as.data.frame(c(rep("ElectrodeOne", 585), rep("ElectrodeTwo", 585), rep("ElectrodeThree", 585)))
colnames(ElectrodeIV) <- "ElectrodeIV"
dim(ElectrodeIV)

COV <- as.data.frame(rep(data$RST_BIS[1:39], 45))
colnames(COV) <- "COV"
dim(COV)
names(data)

# DV <- c(data[1:40,3], data[1:39,4], data[1:39,5], data[1:39,6], data[1:39,7], data[1:39,8], data[1:39,9], data[1:39, 10], data[1:39, 11], data[1:39, 12], data[1:39, 13], data[1:39, 14])
DV00 <- gather(data, "DVcat", "DV", -Subject, -Oss, -RST_BIS, -`...48`) 
DV0 <- as.data.frame(DV00[,-c(3:5)]) # we dont need this
names(data)
names(DV00)
names(DV0)
boom <- cbind(DV0, COV, IntensityIV, EmotionIV, ElectrodeIV)
data <- boom

# factor and order
data$IntensityIV <- factor(data$IntensityIV, levels = c("One", "Two", "Three", "Four", "Five"), ordered = TRUE)
data$EmotionIV <- factor(data$EmotionIV)
data$ElectrodeIV <- factor(data$ElectrodeIV)

```
Running an initial ANCOVA

# Descriptives 
Number of samples and mean (SD) in levels of the independant variables. We reproduce the mean and sd values of Table 2 of this study
```{r}
a = sprintf("%.1f (%.1f)", mean(data$DV[data$EmotionIV == "Neutral"]), sd(data$DV[data$EmotionIV == "Neutral"]))
b = sprintf("%.1f (%.1f)", mean(data$DV[data$EmotionIV == "Positive"]), sd(data$DV[data$EmotionIV == "Positive"]))
c = sprintf("%.1f (%.1f)", mean(data$DV[data$EmotionIV == "Negative"]), sd(data$DV[data$EmotionIV == "Negative"]))
d = sprintf("%.1f (%.1f)", mean(data$DV[data$IntensityIV == "One"]), sd(data$DV[data$IntensityIV == "One"]))
e = sprintf("%.1f (%.1f)", mean(data$DV[data$IntensityIV == "Two"]), sd(data$DV[data$IntensityIV == "Two"]))
f = sprintf("%.1f (%.1f)", mean(data$DV[data$IntensityIV == "Three"]), sd(data$DV[data$IntensityIV == "Three"]))
g = sprintf("%.1f (%.1f)", mean(data$DV[data$IntensityIV == "Four"]), sd(data$DV[data$IntensityIV == "Four"]))
h = sprintf("%.1f (%.1f)", mean(data$DV[data$IntensityIV == "Five"]), sd(data$DV[data$IntensityIV == "Five"]))
i = sprintf("%.1f (%.1f)", mean(data$DV[data$ElectrodeIV == "ElectrodeOne"]), sd(data$DV[data$ElectrodeIV == "ElectrodeOne"]))
j = sprintf("%.1f (%.1f)", mean(data$DV[data$ElectrodeIV == "ElectrodeTwo"]), sd(data$DV[data$ElectrodeIV == "ElectrodeTwo"]))
k = sprintf("%.1f (%.1f)", mean(data$DV[data$ElectrodeIV == "ElectrodeThree"]), sd(data$DV[data$ElectrodeIV == "ElectrodeThree"]))

idx = c(1, 3, 2, 4) # sorting as in publication
tab.dv = array(NA, dim=c(11,3))
tab.dv
tab.dv[,1] = c("Emotion neutral ", "Emotion negative", "Emotion positive", "Intensity One", "Intensity Two", "Intensity Three", "Intensity Four", "Intensity Five", "Electrode One", "Electrode Two", "Electrode Three")
tab.dv[,2] = c("39", "39", "39", "39", "39", "39", "39", "39", "39", "39", "39")
tab.dv[,3] = c(a, b, c, d, e, f, g, h, i, j, k)
colnames(tab.dv) = c("group", "n", "mean (SD)")
print(tab.dv)
```

# Interpreting the main effects of ANCOVA
Main effects of ANCOVA
```{r, include = TRUE, echo = FALSE, eval = TRUE, tidy = TRUE}
#contrasts(data$IV)<-cbind(c(-2,1,1), c(0,-1,1))
contrasts(boom$IntensityIV) <-contr.helmert(5)
contrasts(boom$EmotionIV) <-contr.helmert(3)
contrasts(boom$Electrode) <-contr.helmert(3)
#repeated measures using aov() command
ancovaModel<-aov(
  DV ~ COV + EmotionIV*IntensityIV*ElectrodeIV + Error(Oss/(EmotionIV*IntensityIV*ElectrodeIV)),  data = data)
              #https://personality-project.org/r/r.guide/r.anova.html   
summary(ancovaModel)

summary(Anova(ancovaModel, idata=intra, idesign=~EmotionIV*IntensityIV*ElectrodeIV, multivariate=TRUE, univariate= FALSE))

fit = aggregate(DV ~ COV +  EmotionIV*IntensityIV*ElectrodeIV, data = data, mean)
aov(DV~COV + EmotionIV*IntensityIV*ElectrodeIV + Error(Oss/(EmotionIV*IntensityIV*ElectrodeIV, fit)))

# Fvalue =  13.12
# df1 = 1
# df2 = 37
# pvalue = 0.0009
# estimates = as.data.frame(cbind(F, df1, df2, pvalue))
# rownames(estimates) = c("Study")
# estimates
```
<p align="left">
  <b> Definitions </b>
</p>  
<p align="left">
- The rationale for ANCOVA is two folds:
  1. Reduce within-group error variance
  2. Eliminate confounders
- An ANOVA is a type of linear regression model, an ANCOVA is an ANOVA, which accounts for potential confounders which are usually continuous variables
- An ANCOVA model is the analysis of covariance where the variance of the outcome is explained by discrete variable (Independant variable) and covariates which are continuous variables.
</p>

Checking Assumptions 

## Motivation


```{r, include = TRUE, echo = TRUE, eval = TRUE, tidy = TRUE}

stats.rep.EmotionIV = data.frame(Fvalue = sprintf("%.2f",result$`F value`[5]),
                          df1 = result$Df[5],
                          df2 = result$Df[8],
                          pvalue = formatPval(result$`Pr(>F)`[5]))

stats.rep.ElectrodeIv = data.frame(Fvalue = sprintf("%.2f",result$`F value`[6]),
                          df1 = result$Df[6],
                          df2 = result$Df[8],
                          pvalue = formatPval(result$`Pr(>F)`[6]))

stats.rep.CV = data.frame(Fvalue = sprintf("%.2f",result$`F value`[2]),
                          df1 = result$Df[2],
                          df2 = result$Df[8],
                          pvalue = formatPval(result$`Pr(>F)`[2]))


stats.rep.IntensityIV = data.frame(Fvalue = sprintf("%.2f",result$`F value`[4]),
                          df1 = result$Df[4],
                          df2 = result$Df[8],
                          pvalue = formatPval(result$`Pr(>F)`[4]))
```


# Comparing ANCOVA in original study with reanalysis
## Independant variable
```{r}
tab.IV = rbind(stats.orig.EmotionIV, stats.orig.ElectrodeIV, stats.orig.IntensityIV, stats.rep.EmotionIV, stats.rep.IntensityIV, stats.rep.IntensityIV)
rownames(tab.IV) = c("original study Emotion IV", "original study Electrode IV",  "original study Intensity IV", "reanalysis for Emotion IV", "reanalysis for Intensity IV",  "reanalysis study Intensity IV")
print(t(tab.IV))
```

## Covariate
* The study does not report results from covariate of age
```{r}
tab.CV = rbind(stats.orig.allCV, stats.rep.CVage, stats.rep.CVsex, stats.rep.CVhypertension)
rownames(tab.CV) = c("original CV age,sex,hypertension", "reanalysis age", "reanalysis sex", "reanalysis hypertension")
print(t(tab.CV))
```


# Assumptions
## 1.  Homogeneity of variance
* ANOVA/ANCOVA is fairly robust in terms of the error rate when sample sizes are equal.
* When groups with larger sample sizes have larger variances than the groups with smaller sample sizes, the resulting F-ratio tends to be conservative. That is, it's more likely to produce a non-significant result when a genuine difference does exist in the population.
* Conversely, when the groups with larger sample sizes have smaller variances than the groups with smaller samples sizes, the resulting F-ratio tends to be liberal and can inflate the false positive rate.
* In this study, statistical descriptives show that the highest and lowest variances seem close. Also, there is homogeneity of variance as p values exceed 0.05 for the Levene's test
```{r}
tapply(data$DV, data$EmotionIV, sd)
tapply(data$DV, data$ElectrodeIV, sd)
tapply(data$DV, data$IntensityIV, sd)
leveneTest(DV ~ EmotionIV, data = data) 
leveneTest(DV ~ ElectrodeIV, data = data)
leveneTest(DV ~ IntensityIV, data = data)
```

## 2.  Independence between covariate and IV

```{r}
fit.cv = aov(COV ~ EmotionIV + IntensityIV + ElectrodeIV, data = data) 
summary(fit.cv) 
```
## 3. Homogeneity of regression slopes
* There is no evidence of significant interaction between covariate and independant variable. Thus we can assume homogeneity of regression slope. 
```{r}
#alternatively Anova(aov(AB38 ~age*mb_presence_b + age + mb_presence_b, data = data), type = 3)
fit.hrs_Emotion = aov(DV ~ COV*EmotionIV, data = data)
Anova(fit.hrs_Emotion, type=3) # no evidence of interaction, there is homogeneity of IV levels across age
fit.hrs_Intensity = aov(DV ~ COV*IntensityIV, data = data)
Anova(fit.hrs_Intensity, type=3) 
fit.hrs_Electrode = aov(DV ~ COV*ElectrodeIV, data = data)
Anova(fit.hrs_Electrode, type=3) 
```
  
  
## Independance of Covariate with Independant Variables (Visual inspection of Homogeneity of Regression slopes)
* Visually, the two levels of each independant variable follows the same pattern - there seems to be independance of Covariate versus independant variable.
```{r fig.height=2, fig.width=3.5}
ggplot(data, aes(y=DV, x= COV, group = ElectrodeIV, color = ElectrodeIV)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.15, height = 0), alpha = 0.05) +
  geom_smooth(formula = y ~ x,method=lm, se=FALSE, fullrange=TRUE) +
  theme_minimal() +
  theme(axis.text.x = element_blank(), legend.title = element_blank()) +
  xlab("COV") + ylab("DV") + ggtitle("Covariate with Electrode location")

ggplot(data, aes(y=DV, x= COV, color= EmotionIV)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.15, height = 0), alpha = 0.05) +
  geom_smooth(formula = y ~ x,method=lm, se=FALSE, fullrange=TRUE) +
  theme_minimal() +
  theme(axis.text.x = element_blank(), legend.title = element_blank()) +
  xlab("COV") + ylab("DV") + ggtitle("Covariate with Emotion type")

ggplot(data, aes(y=DV, x= COV, color= IntensityIV)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.15, height = 0), alpha = 0.05) +
  geom_smooth(formula = y ~ x,method=lm, se=FALSE, fullrange=TRUE) +
  theme_minimal() +
  theme(axis.text.x = element_blank(), legend.title = element_blank()) +
  xlab("COV") + ylab("DV") + ggtitle("Covariate with Intensity type")
  
```  
  
Reference : Field, Miles & Miles (2012), Discovering Statistics, Published by Sage Pub, UK.
